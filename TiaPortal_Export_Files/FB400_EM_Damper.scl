FUNCTION_BLOCK "FB400_EM_Damper"
{
    S7_Optimized_Access := 'TRUE'
}
AUTHOR : 'Dallas Levine & Gemini'
VERSION : '1.2' // Logic updated to include damper failure alarm.

VAR_INPUT
    // Enables the block's execution (typically tied to fan status).
    Enable : Bool;
    
    // The final damper position command (0.0 - 100.0%) from the main logic.
    // This block passes this value to its output.
    Damper_Demand_In : Real;
    
    // The cooling demand (0.0 - 100.0%) from the main PID controller.
    // This is required to determine if economizer mode should be activated.
    Cooling_Demand : Real;
END_VAR

VAR
    // The data interface for the Damper Equipment Module.
    UDT : "UDT400_EM_Damper";

    // Internal timer for the fault delay.
    faultDelayTimer : TON_TIME;
END_VAR

BEGIN
    //================================================================================
    // REGION 1: Main Execution Logic
    //================================================================================
    IF #Enable THEN
        
        //----------------------------------------------------------------------------
        // SUB-REGION 1.1: Economizer Mode Calculation
        //----------------------------------------------------------------------------
        IF (#Cooling_Demand > 1.0) AND
           (#UDT.Outside_Air_Temp_AI < (#UDT.Return_Air_Temp_AI - #UDT.Econ_Temp_Diff)) AND
           (#UDT.Outside_Air_Temp_AI < #UDT.Econ_High_Limit)
        THEN
            #UDT.Econ_Mode_Active := TRUE;
        ELSE
            #UDT.Econ_Mode_Active := FALSE;
        END_IF;
        
        //----------------------------------------------------------------------------
        // SUB-REGION 1.2: Damper Position Command
        //----------------------------------------------------------------------------
        #UDT.Damper_Pos_Cmd_AO := #Damper_Demand_In;
        
        //----------------------------------------------------------------------------
        // SUB-REGION 1.3: Damper Failure Alarm
        // If feedback does not match the command for a set time, trigger an alarm.
        //----------------------------------------------------------------------------
        #faultDelayTimer(
            IN := (ABS(#UDT.Damper_Pos_Cmd_AO - #UDT.Damper_Pos_Fdbk_AI) > 5.0),
            PT := #UDT.Fault_Delay_Sec,
            Q  => NOP,
            ET => NOP
        );

        IF #faultDelayTimer.Q THEN
            #UDT.Damper_Failure_Alm := TRUE;
        END_IF;

    ELSE // This ELSE corresponds to "IF #Enable"
        //============================================================================
        // REGION 2: Disabled State Logic
        //----------------------------------------------------------------------------
        #UDT.Econ_Mode_Active := FALSE;
        #UDT.Damper_Pos_Cmd_AO := 0.0;
        #UDT.Damper_Failure_Alm := FALSE; // Reset alarm when disabled.
        
    END_IF;

END_FUNCTION_BLOCK