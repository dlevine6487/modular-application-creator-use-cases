FUNCTION_BLOCK "FB_CondensationPrevention"
{
    S7_Optimized_Access := 'TRUE'
}
VERSION : 1.0
   VAR_INPUT
      Commanded_Cooling_Pos : Real; // Commanded position from primary PID (0-100%)
      OutsideAir_Temp : Real; // Outside Air Temperature in 째F
      OutsideAir_RH : Real; // Outside Air Relative Humidity in %
      SupplyAir_Temp : Real; // Supply Air Temperature (downstream of coil) in 째F
      DewPoint_Safety_Margin : Real; // Safety margin in 째F (e.g., 2.0)
      Min_Supply_Air_Temp_SP : Real; // Hard lower limit for SA_Temp (e.g., 55.0 째F)
   END_VAR

   VAR_OUTPUT
      Cooling_Override_Active : Bool; // TRUE if override is active
      Limited_Cooling_Pos : Real; // Final, safe valve position to be sent to the AO
   END_VAR

   VAR_TEMP
      OutsideAir_DewPoint : Real; // Calculated Dew Point of the outside air
      Supply_Air_Temp_Limit : Real; // Calculated minimum allowable SA Temp
      Temp_C : Real;
      P_ws : Real;
      P_w : Real;
      // Magnus formula constants
      A : Real := 611.2;
      B : Real := 17.67;
      C : Real := 243.5;
   END_VAR


BEGIN
    // == Step 1: Calculate Outside Air Dew Point in Fahrenheit ==

    // Convert Temperature to Celsius for the formula
    #Temp_C := (#OutsideAir_Temp - 32.0) * 5.0 / 9.0;

    // Calculate Partial Pressure of Water Vapor (P_w) in Pascals
    #P_w := #A * EXP((#B * #Temp_C) / (#C + #Temp_C)) * (#OutsideAir_RH / 100.0);

    // Calculate Dew Point in Celsius using the Magnus formula inverse
    #OutsideAir_DewPoint := (#C * LN(#P_w / #A)) / (#B - LN(#P_w / #A));

    // Convert Dew Point back to Fahrenheit
    #OutsideAir_DewPoint := #OutsideAir_DewPoint * 9.0 / 5.0 + 32.0;

    // == Step 2: Determine the Supply Air Temperature Limit ==
    #Supply_Air_Temp_Limit := #OutsideAir_DewPoint + #DewPoint_Safety_Margin;

    // == Step 3: Implement Override Logic ==
    IF #SupplyAir_Temp < #Supply_Air_Temp_Limit OR #SupplyAir_Temp < #Min_Supply_Air_Temp_SP THEN
        // OVERRIDE ACTIVE: The supply air is too cold, risking condensation.
        #Cooling_Override_Active := TRUE;

        // Take decisive action: close the cooling valve to allow the temperature to rise.
        // A more advanced strategy could use a PID to maintain the SA_Temp right at the limit,
        // but a hard override is safer for this implementation.
        #Limited_Cooling_Pos := 0.0;

    ELSE
        // NORMAL OPERATION: No risk of condensation.
        #Cooling_Override_Active := FALSE;

        // Pass the primary controller's commanded position through to the output.
        #Limited_Cooling_Pos := #Commanded_Cooling_Pos;
    END_IF;

END_FUNCTION_BLOCK
