FUNCTION_BLOCK "FB_CalculateAirEnthalpy"
{
    S7_Optimized_Access := 'TRUE'
}
VERSION : 1.0
   VAR_INPUT
      Temperature : Real; // Air Temperature in degrees Fahrenheit
      RelativeHumidity : Real; // Relative Humidity in %
      AtmosphericPressure : Real; // Barometric pressure in Pascals (e.g., 101325 Pa for sea level)
   END_VAR

   VAR_OUTPUT
      Enthalpy : Real; // Calculated Enthalpy in BTU/lb
   END_VAR

   VAR_TEMP
      Temp_C : Real; // Temperature in Celsius
      P_ws : Real; // Saturation vapor pressure in Pascals
      P_w : Real; // Partial pressure of water vapor in Pascals
      MixingRatio : Real; // Humidity Ratio (lb water/lb dry air)
   END_VAR


BEGIN
    // This implementation uses a more accurate formula for psychrometric calculations.

    // Step 1: Convert Temperature from Fahrenheit to Celsius
    #Temp_C := (#Temperature - 32.0) * 5.0 / 9.0;

    // Step 2: Calculate Saturation Vapor Pressure (P_ws) using the ASHRAE formulation, valid for 0-200째C
    // P_ws in Pascals
    #P_ws := EXP(-5800.2206 / (#Temp_C + 273.15) + 1.3914993 - 0.048640239 * (#Temp_C + 273.15)
              + 0.41764768E-4 * (#Temp_C + 273.15)**2 - 0.14452093E-7 * (#Temp_C + 273.15)**3
              + 6.5459673 * LN(#Temp_C + 273.15));

    // Step 3: Calculate Partial Pressure of Water Vapor (P_w)
    // P_w in Pascals
    #P_w := #P_ws * (#RelativeHumidity / 100.0);

    // Step 4: Calculate Humidity Ratio (MixingRatio or W)
    // Formula: W = 0.621945 * (P_w / (P_atm - P_w))
    #MixingRatio := 0.621945 * (#P_w / (#AtmosphericPressure - #P_w)); // Result is lb_water / lb_dry_air

    // Step 5: Calculate Enthalpy (h) in BTU/lb
    // Formula: h = c_pa * T_F + W * (h_fg + c_pw * T_F)
    // c_pa = 0.240 BTU/lb째F (specific heat of dry air)
    // h_fg = 1061 BTU/lb (latent heat of vaporization of water at 32째F)
    // c_pw = 0.444 BTU/lb째F (specific heat of water vapor)
    #Enthalpy := (0.240 * #Temperature) + #MixingRatio * (1061.0 + 0.444 * #Temperature);

END_FUNCTION_BLOCK
