FUNCTION_BLOCK "FB300_EM_Heating"
{
    S7_Optimized_Access := 'TRUE'
}
AUTHOR : 'Dallas Levine & Gemini'
VERSION : '2.0' // Added Valve Failure alarm logic

VAR_INPUT
    // Enables the block's execution.
    Enable : Bool;
    
    // Analog heating demand (0.0 - 100.0%) from the main temperature controller.
    Valve_Demand_In : Real;
END_VAR

VAR
    // The data interface for the Heating Equipment Module.
    UDT : "UDT300_EM_Heating";

    // Internal timer for the valve failure delay.
    valveFailureTimer : TON_TIME;
END_VAR

BEGIN
    //================================================================================
    // REGION 1: Main Execution Logic
    //================================================================================
    IF #Enable THEN
    
        //----------------------------------------------------------------------------
        // SUB-REGION 1.1: Safety Monitoring (Highest Priority)
        // A freeze stat trip must immediately override all other logic.
        //----------------------------------------------------------------------------
        
        IF #UDT.HW_Freeze_Stat_DI THEN
            #UDT.HW_Freeze_Alm := TRUE;
            #UDT.HW_Valve_Cmd_AO := 0.0;
            
        ELSE
            //------------------------------------------------------------------------
            // SUB-REGION 1.2: Normal Operation
            // If no safety faults are active, operate normally.
            //------------------------------------------------------------------------
            
            #UDT.HW_Freeze_Alm := FALSE;
            
            // Pass the incoming analog demand to the analog output command.
            #UDT.HW_Valve_Cmd_AO := #Valve_Demand_In;
            
            //------------------------------------------------------------------------
            // SUB-REGION 1.3: Valve Failure Monitoring
            // Compares the valve command to its feedback after a delay.
            //------------------------------------------------------------------------

            #valveFailureTimer(
                IN := #UDT.HW_Valve_Cmd_AO > 5.0 AND ABS(#UDT.HW_Valve_Cmd_AO - #UDT.HW_Valve_Fdbk_AI) > #UDT.Valve_Fdbk_Tolerance,
                PT := #UDT.Valve_Failure_Delay_Sec,
                Q => NOP,
                ET => NOP
            );

            IF #valveFailureTimer.Q THEN
                #UDT.HW_Valve_Failure_Alm := TRUE;
            END_IF;

            IF NOT #valveFailureTimer.IN THEN
                #UDT.HW_Valve_Failure_Alm := FALSE;
            END_IF;

        END_IF;
        
    ELSE // This ELSE corresponds to "IF #Enable"
        //============================================================================
        // REGION 2: Disabled State Logic
        // If disabled, force outputs to a safe state and reset all alarms.
        //============================================================================
        
        #UDT.HW_Valve_Cmd_AO := 0.0;
        #UDT.HW_Freeze_Alm := FALSE;
        #UDT.HW_Valve_Failure_Alm := FALSE;
        
    END_IF;

END_FUNCTION_BLOCK